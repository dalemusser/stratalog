# Docker Compose for StrataLog Local Development
# Usage:
#   docker compose up -d          # Start all services
#   docker compose up -d mongodb  # Start only MongoDB
#   docker compose logs -f app    # Follow app logs
#   docker compose down           # Stop all services
#   docker compose down -v        # Stop and remove volumes

services:
  # ==========================================================================
  # MongoDB Database
  # ==========================================================================
  mongodb:
    image: mongo:7
    container_name: stratalog-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      # For development, no auth. In production, use MONGO_INITDB_ROOT_USERNAME/PASSWORD
      MONGO_INITDB_DATABASE: stratalog
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================================================
  # Mailpit - Email Testing (captures all outgoing emails)
  # Web UI: http://localhost:8025
  # SMTP: localhost:1025
  # ==========================================================================
  mailpit:
    image: axllent/mailpit:latest
    container_name: stratalog-mailpit
    restart: unless-stopped
    ports:
      - "1025:1025"   # SMTP server
      - "8025:8025"   # Web UI
    logging:
      driver: "none"  # Reduce log noise

  # ==========================================================================
  # StrataLog Application
  # ==========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stratalog-app
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      mongodb:
        condition: service_healthy
      mailpit:
        condition: service_started
    environment:
      # Runtime
      STRATALOG_ENV: dev
      STRATALOG_LOG_LEVEL: debug

      # Database
      STRATALOG_MONGO_URI: mongodb://mongodb:27017
      STRATALOG_MONGO_DATABASE: stratalog

      # Email (Mailpit)
      STRATALOG_MAIL_SMTP_HOST: mailpit
      STRATALOG_MAIL_SMTP_PORT: 1025
      STRATALOG_MAIL_FROM: noreply@localhost
      STRATALOG_MAIL_FROM_NAME: StrataLog
      STRATALOG_BASE_URL: http://localhost:8080

      # Sessions (dev keys - change in production!)
      STRATALOG_SESSION_KEY: docker-dev-session-key-change-in-prod-1234
      STRATALOG_CSRF_KEY: docker-dev-csrf-key-change-in-production-1234

      # Log API
      STRATALOG_API_KEY: docker-dev-api-key-for-testing
      STRATALOG_MAX_BATCH_SIZE: 100
      STRATALOG_MAX_BODY_SIZE: 1048576

      # File storage
      STRATALOG_STORAGE_TYPE: local
      STRATALOG_STORAGE_LOCAL_PATH: /app/uploads
      STRATALOG_STORAGE_LOCAL_URL: /files
    volumes:
      # Persist uploaded files
      - uploads_data:/app/uploads
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  mongodb_data:
    name: stratalog-mongodb-data
  uploads_data:
    name: stratalog-uploads

# ==========================================================================
# Development Tips:
# ==========================================================================
#
# 1. Run only dependencies (MongoDB + Mailpit) for local Go development:
#    docker compose up -d mongodb mailpit
#    Then run: go run ./cmd/stratalog
#
# 2. View captured emails:
#    Open http://localhost:8025 in your browser
#
# 3. Connect to MongoDB:
#    mongosh mongodb://localhost:27017/stratalog
#
# 4. View app logs:
#    docker compose logs -f app
#
# 5. Rebuild after code changes:
#    docker compose up -d --build app
#
# 6. Reset database:
#    docker compose down -v
#    docker compose up -d
#
# 7. Test Log API:
#    curl -X POST http://localhost:8080/api/v1/logs \
#      -H "Authorization: Bearer docker-dev-api-key-for-testing" \
#      -H "Content-Type: application/json" \
#      -d '{"game":"test","player_id":"player1","event_type":"login"}'
